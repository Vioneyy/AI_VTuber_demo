AI VTuber Demo – รายงานสแกนโค้ดและปัญหาที่พบ
วันที่สแกน: ระบบอัตโนมัติ (ปัจจุบัน)

สรุปภาพรวม
- โปรเจคมีโมดูลหลัก: Discord Bot, Queue Manager, LLM (ChatGPTClient), Personality System, TTS (F5-TTS-Thai), STT (whisper.cpp), YouTube Live Adapter, และระบบ Safety/Admin
- ระบบต่อเชื่อมแบบ Orchestrator ใน `src/ai_vtuber.py` ทำงานร่วมกับคิวแบบทีละงาน โดย Discord ได้รับความสำคัญสูง

ประเด็นสำคัญที่ตรวจพบ (Problems)
1) ชื่อตัวแปร ENV สำหรับ Discord token ไม่ตรงกัน
   - โค้ด: `src/ai_vtuber.py` ใช้ `DISCORD_TOKEN`
   - ตัวอย่าง `.env.example`: ใช้ `DISCORD_BOT_TOKEN`
   - ผลกระทบ: บอทอาจไม่เริ่มทำงาน หากผู้ใช้ตั้งค่าเฉพาะ `DISCORD_BOT_TOKEN`
   - แนวทางแก้: รวมชื่อให้สอดคล้อง หรืออ่านทั้งสองตัวแปร

2) การเปิด/ปิด STT มีตัวแปร ENV ไม่สอดคล้องกัน
   - โค้ด: `ai_vtuber.py` ตรวจ `STT_ENABLED` และ `DISABLE_STT`
   - ตัวอย่าง `.env.example`: มี `DISCORD_VOICE_STT_ENABLED`
   - ผลกระทบ: ผู้ใช้ตั้งค่าใน `.env` แล้ว STT อาจไม่ถูกเปิด/ปิดตามต้องการ
   - แนวทางแก้: ใช้ตัวแปรเดียวให้ชัดเจน หรือรองรับทั้งสองแบบ

3) ระบบแก้ปัญหา Discord Voice (`discord_voice_fix.py`) ไม่ถูกใช้งานจริง
   - ไม่พบการเรียกใช้ `VoiceConnectionFixer` ในบอท
   - ผลกระทบ: ปัญหา Error 4006/IPv6 อาจยังเกิด
   - แนวทางแก้: เรียกใช้ `force_ipv4()` ก่อนเชื่อมต่อ หรือใช้ `robust_voice_connect()`

4) การเล่นเสียงจาก bytes โดยตรงใน `DiscordBot.play_audio`
   - ใช้ `discord.PCMAudio(io.BytesIO(audio_data))` ซึ่งรองรับเฉพาะสตรีม PCM raw (48kHz, 16-bit, stereo)
   - ในระบบหลัก ใช้ไฟล์ WAV + `FFmpegPCMAudio` (ถูกต้องกว่า)
   - ผลกระทบ: ฟังก์ชัน `play_audio` อาจเล่นไม่สำเร็จหากส่ง WAV bytes ตรงๆ
   - แนวทางแก้: ใช้ FFmpegPCMAudio กับไฟล์ หรือแปลง bytes ให้เป็น PCM raw ตามสเปก

5) คำสั่งแอดมินไม่ได้เชื่อมกับ Discord เดิม (ก่อนแก้ไข)
   - มีระบบ `AdminCommandHandler` และ `ResponseGenerator` ตรวจ `can_reveal_project_info()`
   - แต่เดิมไม่พบคำสั่ง `!unlock/!lock/...` ใน Discord เพื่อตั้งค่าสถานะ
   - ผลกระทบ: ไม่สามารถควบคุมการเปิดเผยข้อมูลโปรเจคได้จาก Discord
   - แนวทางแก้: เพิ่มคำสั่งในบอท (เช่น `!unlock`, `!lock`, `!status`, `!queue`, `!approve`, `!reject`, `!skip`)

6) ตัวแปร ENV อื่นๆ ที่อาจไม่ถูกใช้งานจริง
   - `.env.example` มี `DISCORD_AUTO_JOIN`, `DISCORD_VOICE_CHANNEL_ID`, `DISCORD_ENABLE_MEMBERS`, ฯลฯ แต่ไม่พบการใช้งานในโค้ดปัจจุบัน
   - ผลกระทบ: ผู้ใช้สับสนว่าตัวแปรมีผลจริงหรือไม่
   - แนวทางแก้: ลบออกจากเทมเพลต หรือเพิ่มการใช้งานให้มีผลจริง

7) การกรองคำถามเกี่ยวกับโปรเจค/เทคนิคใน `ResponseGenerator._is_project_related`
   - ใช้คีย์เวิร์ดง่ายๆ อาจปฏิเสธคำถามที่ปลอดภัยหรือไม่เกี่ยวข้อง
   - แนวทางแก้: ปรับปรุงเงื่อนไข/เพิ่มคอนเท็กซ์หรือระบบ approval ให้เหมาะสม

8) YouTube Live Adapter
   - มีการอ่าน `pytchat.LiveChat` และส่งข้อความเข้าคิวพร้อม cooldown
   - ข้อสังเกต: ฟิลเตอร์ `_should_ignore_message` ใช้งานได้ดี แต่ไม่มีระบบคำสั่งแอดมินสำหรับ YouTube (ตามที่ตั้งใจ)
   - แนวทางแก้: หากต้องการควบคุมจาก YouTube ให้เพิ่มคำสั่ง/สิทธิ์อย่างระมัดระวัง

9) TTS (F5-TTS-Thai)
   - รองรับตัวแปร ENV เช่น `F5_TTS_USE_REFERENCE`, `TTS_REFERENCE_WAV`, `F5_TTS_REF_TEXT`, `F5_TTS_SPEED`, `F5_TTS_STEPS`, `F5_TTS_CFG_STRENGTH`, `F5_TTS_SAMPLE_RATE`
   - ข้อสังเกต: การใช้ ref_audio/ref_text ต้องระวังการพูดทับ ref_text
   - แนวทางแก้: ควบคุม `F5_TTS_USE_REFERENCE` และ `F5_TTS_REF_TEXT` ให้เหมาะกับ workflow

คำแนะนำเชิงปฏิบัติ (Recommendations)
- รวมชื่อ ENV ให้สอดคล้อง: `DISCORD_TOKEN`/`DISCORD_BOT_TOKEN`, `STT_ENABLED`/`DISCORD_VOICE_STT_ENABLED`
- ผสาน Discord Voice Fixer เข้ากับขั้นตอนเชื่อมต่อ voice
- ตัดตัวแปรที่ไม่ใช้จริงออกจาก `.env.example` หรือเพิ่มการใช้งานให้ชัดเจน
- ยืนยันรูปแบบเสียงเมื่อเล่นจาก bytes ให้เป็น PCM raw หรือใช้ FFmpegPCMAudio กับไฟล์ WAV
- ปรับปรุงตรรกะกรองคำถามเกี่ยวกับโปรเจคให้นุ่มนวลและแม่นยำขึ้น

หมายเหตุ
- รายงานนี้ไม่รวมผลการทดสอบรันจริงกับ Discord/YouTube
- หากต้องการ เราสามารถเพิ่มสคริปต์ทดสอบอัตโนมัติและ CI สำหรับตรวจ ENV/การเชื่อมต่อเบื้องต้น

จบรายงาน